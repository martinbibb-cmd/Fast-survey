<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Survey Output Summary</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="output-page">
  <div class="output-shell">
    <header class="output-header">
      <div class="brand">
        <span class="brand-mark" aria-hidden="true">ðŸ”¥</span>
        <h1>Survey Output Summary</h1>
      </div>
      <a class="ghost" href="index.html">Back to planner</a>
    </header>

    <main class="output-grid" aria-live="polite">
      <section class="output-card" aria-labelledby="outputWorkingHeights">
        <div class="output-card-head">
          <h2 id="outputWorkingHeights">Working at heights</h2>
          <button type="button" class="copy-button" data-output-key="workingAtHeights">Copy</button>
        </div>
        <pre class="output-content" data-output-field="workingAtHeights"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputSystemCharacteristics">
        <div class="output-card-head">
          <h2 id="outputSystemCharacteristics">System characteristics</h2>
          <button type="button" class="copy-button" data-output-key="systemCharacteristics">Copy</button>
        </div>
        <pre class="output-content" data-output-field="systemCharacteristics"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputAssistance">
        <div class="output-card-head">
          <h2 id="outputAssistance">Components that require assistance</h2>
          <button type="button" class="copy-button" data-output-key="assistanceComponents">Copy</button>
        </div>
        <pre class="output-content" data-output-field="assistanceComponents"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputRestrictions">
        <div class="output-card-head">
          <h2 id="outputRestrictions">Restrictions to work</h2>
          <button type="button" class="copy-button" data-output-key="restrictions">Copy</button>
        </div>
        <pre class="output-content" data-output-field="restrictions"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputHazards">
        <div class="output-card-head">
          <h2 id="outputHazards">External hazards</h2>
          <button type="button" class="copy-button" data-output-key="externalHazards">Copy</button>
        </div>
        <pre class="output-content" data-output-field="externalHazards"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputNewBoiler">
        <div class="output-card-head">
          <h2 id="outputNewBoiler">New boiler and controls</h2>
          <button type="button" class="copy-button" data-output-key="newBoilerAndControls">Copy</button>
        </div>
        <pre class="output-content" data-output-field="newBoilerAndControls"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputFlue">
        <div class="output-card-head">
          <h2 id="outputFlue">Flue</h2>
          <button type="button" class="copy-button" data-output-key="flue">Copy</button>
        </div>
        <pre class="output-content" data-output-field="flue"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputPipework">
        <div class="output-card-head">
          <h2 id="outputPipework">Pipe work</h2>
          <button type="button" class="copy-button" data-output-key="pipework">Copy</button>
        </div>
        <pre class="output-content" data-output-field="pipework"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputDisruption">
        <div class="output-card-head">
          <h2 id="outputDisruption">Disruption</h2>
          <button type="button" class="copy-button" data-output-key="disruption">Copy</button>
        </div>
        <pre class="output-content" data-output-field="disruption"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputCustomerActions">
        <div class="output-card-head">
          <h2 id="outputCustomerActions">Customer agreed actions</h2>
          <button type="button" class="copy-button" data-output-key="customerAgreedActions">Copy</button>
        </div>
        <pre class="output-content" data-output-field="customerAgreedActions"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputAdditional">
        <div class="output-card-head">
          <h2 id="outputAdditional">Additional</h2>
          <button type="button" class="copy-button" data-output-key="additional">Copy</button>
        </div>
        <pre class="output-content" data-output-field="additional"></pre>
      </section>
    </main>
  </div>

  <script src="output.js" type="module"></script>
  <script src="./js/notes-engine.js"></script>
  <script>
    (function(){
      if (!window.NotesEngine || typeof window.NotesEngine.buildFromPlanner !== 'function') {
        return;
      }

      const sections = NotesEngine.buildFromPlanner() || {};
      const headingMap = {
        Flue: 'Flue',
        Gas: 'Pipe work',
        Condensate: 'Disruption',
        SummaryChange: 'System characteristics',
        SystemChanges: 'Additional',
        HotWater: 'New boiler and controls',
        LocationAndMakingGood: 'Additional',
        Controls: 'New boiler and controls',
        HouseKeeping: 'Disruption'
      };

      const aggregated = {};
      Object.entries(headingMap).forEach(([engineKey, headingText]) => {
        const lines = sections[engineKey];
        if (!Array.isArray(lines) || !lines.length) {
          return;
        }
        if (!aggregated[headingText]) {
          aggregated[headingText] = [];
        }
        aggregated[headingText].push(...lines);
      });

      function findHeadingByText(text) {
        const headings = Array.from(document.querySelectorAll('h2, h3, h4'));
        return headings.find(heading => heading.textContent.trim().toLowerCase() === text.toLowerCase());
      }

      function ensureNotesArea(sectionEl) {
        if (!sectionEl) {
          return null;
        }
        let textarea = sectionEl.querySelector('textarea.notes-engine-output');
        if (!textarea) {
          textarea = document.createElement('textarea');
          textarea.className = 'notes-engine-output';
          textarea.rows = 8;
          textarea.spellcheck = false;
          textarea.style.width = '100%';
          textarea.style.marginTop = '12px';
          const reference = sectionEl.querySelector('.output-content');
          if (reference) {
            sectionEl.insertBefore(textarea, reference);
          } else {
            sectionEl.appendChild(textarea);
          }
          let copyButton = sectionEl.querySelector('button.notes-engine-copy');
          if (!copyButton) {
            copyButton = document.createElement('button');
            copyButton.type = 'button';
            copyButton.textContent = 'Copy notes';
            copyButton.className = 'copy-button notes-engine-copy';
            copyButton.style.margin = '6px 0 12px';
            copyButton.addEventListener('click', () => {
              textarea.select();
              document.execCommand('copy');
            });
            textarea.insertAdjacentElement('afterend', copyButton);
          }
        }
        return textarea;
      }

      Object.entries(aggregated).forEach(([headingText, lines]) => {
        const headingEl = findHeadingByText(headingText);
        if (!headingEl) {
          return;
        }
        const sectionEl = headingEl.closest('.output-card') || headingEl.parentElement;
        const textarea = ensureNotesArea(sectionEl);
        if (!textarea) {
          return;
        }
        textarea.value = lines.join('\n');
      });

      if (Array.isArray(sections.SummaryChange) && sections.SummaryChange.length) {
        const grid = document.querySelector('.output-grid');
        if (grid) {
          const summaryCard = document.createElement('section');
          summaryCard.className = 'output-card notes-summary-card';
          const head = document.createElement('div');
          head.className = 'output-card-head';
          const heading = document.createElement('h2');
          heading.textContent = 'Summary Change';
          head.appendChild(heading);
          summaryCard.appendChild(head);
          const textarea = document.createElement('textarea');
          textarea.className = 'notes-engine-output';
          textarea.rows = 4;
          textarea.spellcheck = false;
          textarea.style.width = '100%';
          textarea.style.marginTop = '12px';
          textarea.value = sections.SummaryChange.join('\n');
          summaryCard.appendChild(textarea);
          const copyButton = document.createElement('button');
          copyButton.type = 'button';
          copyButton.textContent = 'Copy notes';
          copyButton.className = 'copy-button notes-engine-copy';
          copyButton.style.margin = '6px 0 12px';
          copyButton.addEventListener('click', () => {
            textarea.select();
            document.execCommand('copy');
          });
          summaryCard.appendChild(copyButton);
          grid.insertBefore(summaryCard, grid.firstChild);
        }
      }
    })();
  </script>
  <script>
    (function(){
      const shell = document.querySelector('.output-shell');
      if (!shell || shell.querySelector('.notes-copy-all-button')) {
        return;
      }
      const button = document.createElement('button');
      button.type = 'button';
      button.textContent = 'Copy All Notes';
      button.className = 'copy-button notes-copy-all-button';
      button.style.margin = '20px 0';
      button.addEventListener('click', () => {
        const textareas = Array.from(document.querySelectorAll('textarea.notes-engine-output'));
        const combined = textareas.map(t => t.value.trim()).filter(Boolean).join('\n');
        const temp = document.createElement('textarea');
        temp.style.position = 'fixed';
        temp.style.left = '-9999px';
        temp.value = combined;
        document.body.appendChild(temp);
        temp.select();
        document.execCommand('copy');
        document.body.removeChild(temp);
        alert('All sections copied');
      });
      shell.appendChild(button);
    })();
  </script>
  <!-- Depot Router: paste near </body> -->
  <script>
  /* ==== SECTION TARGETS (edit IDs if your page uses different ones) ==== */
  const SECTION_TARGETS = {
    needs:                 '#copy-needs',
    wah:                   '#copy-wah',
    systemCharacteristics: '#copy-system-characteristics',
    arseCoverNotes:        '#copy-arse-cover-notes',
    componentsAssist:      '#copy-components-assistance',
    restrictions:          '#copy-restrictions',
    externalHazards:       '#copy-external-hazards',
    delivery:              '#copy-delivery',
    office:                '#copy-office',
    newBoilerControls:     '#copy-new-boiler-controls',
    flue:                  '#copy-flue',
    pipeWork:              '#copy-pipe-work',
    disruption:            '#copy-disruption',
    customerActions:       '#copy-customer-actions'
  };

  /* ==== PREFIX ROUTING RULES ==== */
  const PREFIX_TO_SECTION = [
    [/^NE\d+/i,                        'needs'],
    [/^WAH\d+/i,                       'wah'],
    [/^(SE|SN)\d+/i,                   'systemCharacteristics'], // SE/SN -> System Characteristics
    [/^SC(5\d)\b/i,                    'systemCharacteristics'], // SC50..SC60 -> System Characteristics
    [/^ARS\d+/i,                       'arseCoverNotes'],
    [/^CS\d+/i,                        'componentsAssist'],
    [/^SR\d+/i,                        'restrictions'],
    [/^(EH|ASB|HAZ)\d+/i,              'externalHazards'],
    [/^DL\d+/i,                        'delivery'],
    [/^OA\d+/i,                        'office'],
    [/^(BLC|BT|BOIL|UC|CYL|SC0|CB)\d*/i,'newBoilerControls'],   // SC0x (system_config) goes here
    [/^(FMG|FN|FLU)\d+/i,              'flue'],
    [/^(GR|GAS|CD|DS|WS)\d+/i,         'pipeWork'],
    [/^(PF|CE|RD|DI)\d+/i,             'disruption'],
    [/^CA\d+/i,                        'customerActions']
  ];

  function resolveSectionForCode(code){
    for (const [re, section] of PREFIX_TO_SECTION) if (re.test(code)) return section;
    return null;
  }

  function getSelectedOptions(){
    return Array.from(document.querySelectorAll('input.opt[type="checkbox"]:checked')).map(el=>{
      const code = (el.dataset.code||'').trim();
      let text   = (el.dataset.text||'').trim();
      if (!text){
        const lbl = el.closest('label') || document.querySelector(`label[for="${el.id}"]`);
        text = lbl ? lbl.textContent.trim() : '';
        if (code && text.startsWith(code)) text = text.replace(code,'').replace(/^[\s|\-â€“â€”:]+/,'').trim();
      }
      return code && text ? {code,text} : null;
    }).filter(Boolean);
  }

  function buildLines(items){ return items.map(({code,text})=>`â†˜ï¸ ${code} | ${text};`).join('\n'); }

  function writeTo(selector, text, {append=false}={}){
    const el = document.querySelector(selector);
    if (!el) return;
    el.value = append && el.value ? el.value.replace(/\s*$/,'') + '\n' + text : text;
  }

  function routeSelectionsToSections({append=false}={}){
    const buckets = {};
    for (const sel of getSelectedOptions()){
      const section = resolveSectionForCode(sel.code);
      if (!section) continue;
      (buckets[section] ||= []).push(sel);
    }
    for (const [key, selector] of Object.entries(SECTION_TARGETS)){
      const items = buckets[key] || [];
      writeTo(selector, items.length ? buildLines(items) : '', {append});
    }
  }

  /* Optional helpers: copy one / copy all */
  function copySelector(selector){
    const el = document.querySelector(selector); if(!el) return;
    el.select(); el.setSelectionRange(0, el.value.length); document.execCommand('copy');
  }
  function copyAllSections(){
    const text = Object.values(SECTION_TARGETS).map(sel=>{
      const el = document.querySelector(sel); return el ? el.value.trim() : '';
    }).filter(Boolean).join('\n');
    const ta = document.createElement('textarea'); ta.style.position='fixed'; ta.style.opacity='0';
    ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
  }

  /* Wire buttons if present */
  function initDepotRouter(){
    const sendBtn = document.querySelector('#send-to-sections');
    if (sendBtn) sendBtn.addEventListener('click', ()=>routeSelectionsToSections({append:false}));
    const sendAppendBtn = document.querySelector('#send-to-sections-append');
    if (sendAppendBtn) sendAppendBtn.addEventListener('click', ()=>routeSelectionsToSections({append:true}));
    document.querySelectorAll('[data-copy-target]').forEach(btn=>{
      btn.addEventListener('click', ()=>copySelector(btn.getAttribute('data-copy-target')));
    });
    const copyAllBtn = document.querySelector('#copy-all-sections');
    if (copyAllBtn) copyAllBtn.addEventListener('click', copyAllSections);
  }
  document.readyState==='loading' ? document.addEventListener('DOMContentLoaded', initDepotRouter) : initDepotRouter();
  </script>
  <script src="./js/gpt-all-13.js"></script>
</body>
</html>
