<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Survey Output Summary</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="output-page">
  <div class="output-shell">
    <header class="output-header">
      <div class="brand">
        <span class="brand-mark" aria-hidden="true">üî•</span>
        <h1>Survey Output Summary</h1>
      </div>
      <div class="output-actions">
        <a class="ghost" href="index.html">Back to planner</a>
        <button class="primary-action" id="generateBtn" type="button">Send to Survey Brain</button>
      </div>
    </header>

    <main class="output-grid" aria-live="polite">
      <section class="output-card" aria-labelledby="apiNotesHeading">
        <div class="output-card-head">
          <h2 id="apiNotesHeading">Survey Brain response</h2>
          <button type="button" class="copy-button" id="copyApiResponse">Copy</button>
        </div>
        <pre class="output-content api-output" id="api-output" data-status="idle">Press ‚ÄúSend to Survey Brain‚Äù to generate structured notes.</pre>
      </section>

      <section class="output-card" aria-labelledby="outputNeeds">
        <div class="output-card-head">
          <h2 id="outputNeeds">Needs</h2>
          <button type="button" class="copy-button" data-output-key="Needs">Copy</button>
        </div>
        <pre class="output-content" data-output-field="Needs"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputWorkingHeights">
        <div class="output-card-head">
          <h2 id="outputWorkingHeights">Working at heights</h2>
          <button type="button" class="copy-button" data-output-key="WorkingAtHeights">Copy</button>
        </div>
        <pre class="output-content" data-output-field="WorkingAtHeights"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputSystemCharacteristics">
        <div class="output-card-head">
          <h2 id="outputSystemCharacteristics">System characteristics</h2>
          <button type="button" class="copy-button" data-output-key="SystemCharacteristics">Copy</button>
        </div>
        <pre class="output-content" data-output-field="SystemCharacteristics"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputAssistance">
        <div class="output-card-head">
          <h2 id="outputAssistance">Components that require assistance</h2>
          <button type="button" class="copy-button" data-output-key="ComponentsAssistance">Copy</button>
        </div>
        <pre class="output-content" data-output-field="ComponentsAssistance"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputPermissions">
        <div class="output-card-head">
          <h2 id="outputPermissions">Permissions</h2>
          <button type="button" class="copy-button" data-output-key="Permissions">Copy</button>
        </div>
        <pre class="output-content" data-output-field="Permissions"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputHazards">
        <div class="output-card-head">
          <h2 id="outputHazards">Hazards</h2>
          <button type="button" class="copy-button" data-output-key="Hazards">Copy</button>
        </div>
        <pre class="output-content" data-output-field="Hazards"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputDelivery">
        <div class="output-card-head">
          <h2 id="outputDelivery">Delivery</h2>
          <button type="button" class="copy-button" data-output-key="Delivery">Copy</button>
        </div>
        <pre class="output-content" data-output-field="Delivery"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputOffice">
        <div class="output-card-head">
          <h2 id="outputOffice">Office</h2>
          <button type="button" class="copy-button" data-output-key="Office">Copy</button>
        </div>
        <pre class="output-content" data-output-field="Office"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputBoilerControls">
        <div class="output-card-head">
          <h2 id="outputBoilerControls">Boiler and controls</h2>
          <button type="button" class="copy-button" data-output-key="BoilerAndControls">Copy</button>
        </div>
        <pre class="output-content" data-output-field="BoilerAndControls"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputFlue">
        <div class="output-card-head">
          <h2 id="outputFlue">Flue</h2>
          <button type="button" class="copy-button" data-output-key="Flue">Copy</button>
        </div>
        <pre class="output-content" data-output-field="Flue"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputPipework">
        <div class="output-card-head">
          <h2 id="outputPipework">Pipe work</h2>
          <button type="button" class="copy-button" data-output-key="PipeWork">Copy</button>
        </div>
        <pre class="output-content" data-output-field="PipeWork"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputDisruption">
        <div class="output-card-head">
          <h2 id="outputDisruption">Disruption</h2>
          <button type="button" class="copy-button" data-output-key="Disruption">Copy</button>
        </div>
        <pre class="output-content" data-output-field="Disruption"></pre>
      </section>

      <section class="output-card" aria-labelledby="outputCustomerActions">
        <div class="output-card-head">
          <h2 id="outputCustomerActions">Customer actions</h2>
          <button type="button" class="copy-button" data-output-key="CustomerActions">Copy</button>
        </div>
        <pre class="output-content" data-output-field="CustomerActions"></pre>
      </section>
    </main>
  </div>

  <script src="output.js" type="module"></script>
  <script src="./js/notes-engine.js"></script>
  <script src="./js/notes-api-client.js"></script>
  <script>
    (function(){
      if (!window.NotesEngine || typeof window.NotesEngine.buildFromPlanner !== 'function') {
        return;
      }

      const sections = window.NotesEngine.buildFromPlanner() || {};
      const keys = window.NotesEngine.SECTION_KEYS || Object.keys(sections);

      function ensureNotesArea(preElement, key) {
        if (!preElement) {
          return null;
        }
        const container = preElement.parentElement;
        if (!container) {
          return null;
        }
        let textarea = container.querySelector(`textarea.notes-engine-output[data-notes-section="${key}"]`);
        if (!textarea) {
          textarea = document.createElement('textarea');
          textarea.className = 'notes-engine-output';
          textarea.rows = 8;
          textarea.spellcheck = false;
          textarea.dataset.notesSection = key;
          textarea.style.width = '100%';
          textarea.style.marginTop = '12px';
          container.insertBefore(textarea, preElement);

          let copyButton = container.querySelector(`button.notes-engine-copy[data-notes-section="${key}"]`);
          if (!copyButton) {
            copyButton = document.createElement('button');
            copyButton.type = 'button';
            copyButton.textContent = 'Copy notes';
            copyButton.className = 'copy-button notes-engine-copy';
            copyButton.dataset.notesSection = key;
            copyButton.style.margin = '6px 0 12px';
            copyButton.addEventListener('click', () => {
              textarea.select();
              document.execCommand('copy');
            });
            textarea.insertAdjacentElement('afterend', copyButton);
          }
        }
        return textarea;
      }

      keys.forEach((key) => {
        const lines = Array.isArray(sections[key]) && sections[key].length
          ? sections[key]
          : ['‚ÜòÔ∏è None recorded;'];
        const target = document.querySelector(`[data-output-field="${key}"]`);
        const textarea = ensureNotesArea(target, key);
        if (textarea) {
          textarea.value = lines.join('\n');
        }
      });

      if (!document.querySelector('.notes-copy-all-button')) {
        const shell = document.querySelector('.output-shell');
        if (shell) {
          const button = document.createElement('button');
          button.type = 'button';
          button.textContent = 'Copy All Notes';
          button.className = 'copy-button notes-copy-all-button';
          button.style.margin = '20px 0';
          button.addEventListener('click', () => {
            const textareas = Array.from(document.querySelectorAll('textarea.notes-engine-output'));
            const combined = textareas.map(t => t.value.trim()).filter(Boolean).join('\n');
            if (!combined) {
              return;
            }
            const temp = document.createElement('textarea');
            temp.style.position = 'fixed';
            temp.style.left = '-9999px';
            temp.value = combined;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            alert('All sections copied');
          });
          shell.appendChild(button);
        }
      }
    })();
  </script>
  <!-- Depot Router: paste near </body> -->
  <script>
  /* ==== SECTION TARGETS (edit IDs if your page uses different ones) ==== */
  const SECTION_TARGETS = {
    needs:                 '#copy-needs',
    wah:                   '#copy-wah',
    systemCharacteristics: '#copy-system-characteristics',
    arseCoverNotes:        '#copy-arse-cover-notes',
    componentsAssist:      '#copy-components-assistance',
    restrictions:          '#copy-restrictions',
    externalHazards:       '#copy-external-hazards',
    delivery:              '#copy-delivery',
    office:                '#copy-office',
    newBoilerControls:     '#copy-new-boiler-controls',
    flue:                  '#copy-flue',
    pipeWork:              '#copy-pipe-work',
    disruption:            '#copy-disruption',
    customerActions:       '#copy-customer-actions'
  };

  /* ==== PREFIX ROUTING RULES ==== */
  const PREFIX_TO_SECTION = [
    [/^NE\d+/i,                        'needs'],
    [/^WAH\d+/i,                       'wah'],
    [/^(SE|SN)\d+/i,                   'systemCharacteristics'], // SE/SN -> System Characteristics
    [/^SC(5\d)\b/i,                    'systemCharacteristics'], // SC50..SC60 -> System Characteristics
    [/^ARS\d+/i,                       'arseCoverNotes'],
    [/^CS\d+/i,                        'componentsAssist'],
    [/^SR\d+/i,                        'restrictions'],
    [/^(EH|ASB|HAZ)\d+/i,              'externalHazards'],
    [/^DL\d+/i,                        'delivery'],
    [/^OA\d+/i,                        'office'],
    [/^(BLC|BT|BOIL|UC|CYL|SC0|CB)\d*/i,'newBoilerControls'],   // SC0x (system_config) goes here
    [/^(FMG|FN|FLU)\d+/i,              'flue'],
    [/^(GR|GAS|CD|DS|WS)\d+/i,         'pipeWork'],
    [/^(PF|CE|RD|DI)\d+/i,             'disruption'],
    [/^CA\d+/i,                        'customerActions']
  ];

  function resolveSectionForCode(code){
    for (const [re, section] of PREFIX_TO_SECTION) if (re.test(code)) return section;
    return null;
  }

  function getSelectedOptions(){
    return Array.from(document.querySelectorAll('input.opt[type="checkbox"]:checked')).map(el=>{
      const code = (el.dataset.code||'').trim();
      let text   = (el.dataset.text||'').trim();
      if (!text){
        const lbl = el.closest('label') || document.querySelector(`label[for="${el.id}"]`);
        text = lbl ? lbl.textContent.trim() : '';
        if (code && text.startsWith(code)) text = text.replace(code,'').replace(/^[\s|\-‚Äì‚Äî:]+/,'').trim();
      }
      return code && text ? {code,text} : null;
    }).filter(Boolean);
  }

  function buildLines(items){ return items.map(({code,text})=>`‚ÜòÔ∏è ${code} | ${text};`).join('\n'); }

  function writeTo(selector, text, {append=false}={}){
    const el = document.querySelector(selector);
    if (!el) return;
    el.value = append && el.value ? el.value.replace(/\s*$/,'') + '\n' + text : text;
  }

  function routeSelectionsToSections({append=false}={}){
    const buckets = {};
    for (const sel of getSelectedOptions()){
      const section = resolveSectionForCode(sel.code);
      if (!section) continue;
      (buckets[section] ||= []).push(sel);
    }
    for (const [key, selector] of Object.entries(SECTION_TARGETS)){
      const items = buckets[key] || [];
      writeTo(selector, items.length ? buildLines(items) : '', {append});
    }
  }

  /* Optional helpers: copy one / copy all */
  function copySelector(selector){
    const el = document.querySelector(selector); if(!el) return;
    el.select(); el.setSelectionRange(0, el.value.length); document.execCommand('copy');
  }
  function copyAllSections(){
    const text = Object.values(SECTION_TARGETS).map(sel=>{
      const el = document.querySelector(sel); return el ? el.value.trim() : '';
    }).filter(Boolean).join('\n');
    const ta = document.createElement('textarea'); ta.style.position='fixed'; ta.style.opacity='0';
    ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
  }

  /* Wire buttons if present */
  function initDepotRouter(){
    const sendBtn = document.querySelector('#send-to-sections');
    if (sendBtn) sendBtn.addEventListener('click', ()=>routeSelectionsToSections({append:false}));
    const sendAppendBtn = document.querySelector('#send-to-sections-append');
    if (sendAppendBtn) sendAppendBtn.addEventListener('click', ()=>routeSelectionsToSections({append:true}));
    document.querySelectorAll('[data-copy-target]').forEach(btn=>{
      btn.addEventListener('click', ()=>copySelector(btn.getAttribute('data-copy-target')));
    });
    const copyAllBtn = document.querySelector('#copy-all-sections');
    if (copyAllBtn) copyAllBtn.addEventListener('click', copyAllSections);
  }
  document.readyState==='loading' ? document.addEventListener('DOMContentLoaded', initDepotRouter) : initDepotRouter();
  </script>
  <script src="./js/gpt-all-13.js"></script>
</body>
</html>
